name: CD - Continuous Deployment

on:
  push:
    branches: [ build ]  # ç›‘å¬ build åˆ†æ”¯çš„æ¨é€
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'
  REGISTRY: docker.io
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/emoji-fusion

permissions:
  contents: read
  packages: write

jobs:
  # Docker æ„å»ºå’Œæ¨é€
  docker-build:
    runs-on: ubuntu-latest
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      image-tags: ${{ steps.meta.outputs.tags }}
    
    steps:
      - name: Checkout build artifacts from build branch
        uses: actions/checkout@v4
        with:
          ref: build  # ä» build åˆ†æ”¯æ£€å‡ºæ„å»ºäº§ç‰©

      - name: Display build info
        run: |
          if [ -f "BUILD_INFO.txt" ]; then
            echo "ğŸ“¦ Build Information:"
            cat BUILD_INFO.txt
          else
            echo "âš ï¸ No build info found"
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
          labels: |
            org.opencontainers.image.title=Emoji Fusion
            org.opencontainers.image.description=A web app to fuse two emojis into one
            org.opencontainers.image.vendor=USYDShawnTan

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false
          sbom: false

      - name: Update Docker Hub description
        uses: peter-evans/dockerhub-description@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          repository: ${{ env.IMAGE_NAME }}
          short-description: "Emoji Fusion - Fuse two emojis into one creative expression"
          readme-filepath: ./README.md

  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy:
    needs: docker-build
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Deploy to production
        run: |
          echo "ğŸš€ Deploying ${{ needs.docker-build.outputs.image-tags }} to production"
          echo "Image digest: ${{ needs.docker-build.outputs.image-digest }}"
          # è¿™é‡Œæ·»åŠ å®é™…çš„éƒ¨ç½²é€»è¾‘
          # ä¾‹å¦‚ï¼š
          # - kubectl set image deployment/emoji-fusion app=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          # - docker-compose up -d
          # - è°ƒç”¨éƒ¨ç½² API
          echo "âœ… Deployment completed successfully"

  # éƒ¨ç½²é€šçŸ¥
  notify:
    needs: [docker-build, deploy]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Deployment notification
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
            echo "ğŸ³ Docker é•œåƒ: ${{ needs.docker-build.outputs.image-tags }}"
            echo "ğŸ“ é•œåƒæ‘˜è¦: ${{ needs.docker-build.outputs.image-digest }}"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥"
            echo "è¯·æ£€æŸ¥éƒ¨ç½²æ—¥å¿—"
          fi
          
          # è¿™é‡Œå¯ä»¥æ·»åŠ é€šçŸ¥é€»è¾‘ï¼Œä¾‹å¦‚ï¼š
          # - å‘é€ Slack æ¶ˆæ¯
          # - å‘é€é‚®ä»¶
          # - è°ƒç”¨ Webhook
