name: CD - Continuous Deployment

on:
  push:
    branches: [ main ]  # ç›‘å¬ main åˆ†æ”¯çš„æ¨é€
    tags:
      - 'v*'
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'
  REGISTRY: docker.io
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/emoji-fusion

permissions:
  contents: read
  packages: write

jobs:
  # Docker æ„å»ºå’Œæ¨é€
  docker-build:
    runs-on: ubuntu-latest
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      image-tags: ${{ steps.meta.outputs.tags }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=tag
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
          labels: |
            org.opencontainers.image.title=Emoji Fusion
            org.opencontainers.image.description=A web app to fuse two emojis into one
            org.opencontainers.image.vendor=USYDShawnTan

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false
          sbom: false

      - name: Update Docker Hub description
        uses: peter-evans/dockerhub-description@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          repository: ${{ env.IMAGE_NAME }}
          short-description: "Emoji Fusion - Fuse two emojis into one creative expression"
          readme-filepath: ./README.md

  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy:
    needs: docker-build
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Deploy to production
        run: |
          echo "ğŸš€ Deploying ${{ needs.docker-build.outputs.image-tags }} to production"
          echo "ğŸ“ Image digest: ${{ needs.docker-build.outputs.image-digest }}"
          
          # æ£€æŸ¥æ˜¯å¦ä¸ºæ ‡ç­¾è§¦å‘çš„éƒ¨ç½²
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "ğŸ·ï¸  Tag deployment: ${{ github.ref_name }}"
            echo "ğŸ¯ This is a versioned release deployment"
          else
            echo "ğŸŒ¿ Branch deployment: ${{ github.ref_name }}"
          fi
          
          # è¿™é‡Œæ·»åŠ å®é™…çš„éƒ¨ç½²é€»è¾‘
          # ä¾‹å¦‚ï¼š
          # - kubectl set image deployment/emoji-fusion app=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}
          # - docker-compose up -d
          # - è°ƒç”¨éƒ¨ç½² API
          echo "âœ… Deployment completed successfully"

  # éƒ¨ç½²é€šçŸ¥
  notify:
    needs: [docker-build, deploy]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Deployment notification
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
            echo "ğŸ³ Docker é•œåƒ: ${{ needs.docker-build.outputs.image-tags }}"
            echo "ğŸ“ é•œåƒæ‘˜è¦: ${{ needs.docker-build.outputs.image-digest }}"
            
            # æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
            if [[ "${{ github.ref }}" == refs/tags/* ]]; then
              echo "ğŸ·ï¸  ç‰ˆæœ¬æ ‡ç­¾: ${{ github.ref_name }}"
              echo "ğŸ‰ æ–°ç‰ˆæœ¬å‘å¸ƒæˆåŠŸï¼"
            else
              echo "ğŸŒ¿ åˆ†æ”¯: ${{ github.ref_name }}"
              echo "ğŸ”„ æŒç»­éƒ¨ç½²å®Œæˆ"
            fi
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥"
            echo "è¯·æ£€æŸ¥éƒ¨ç½²æ—¥å¿—"
          fi
          
          # è¿™é‡Œå¯ä»¥æ·»åŠ é€šçŸ¥é€»è¾‘ï¼Œä¾‹å¦‚ï¼š
          # - å‘é€ Slack æ¶ˆæ¯
          # - å‘é€é‚®ä»¶  
          # - è°ƒç”¨ Webhook
          # - GitHub Release é€šçŸ¥
